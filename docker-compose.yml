services:
  db:
    image: postgres:15-alpine
    container_name: medisupply-db
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-medisupply_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-medisupply_password}
      - POSTGRES_DB=${POSTGRES_DB:-medisupply}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - medisupply-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-medisupply_user}"]
      interval: 10s
      timeout: 5s
      retries: 5

  auth-usuario:
    build:
      context: ./auth-usuario
      dockerfile: Dockerfile
    container_name: medisupply-auth
    ports:
      - "5001:5001"
    environment:
      - FLASK_APP=app.py
      - FLASK_ENV=production
      - PORT=5001
      - DB_HOST=db
      - DB_PORT=5432
      - DB_NAME=${POSTGRES_DB:-medisupply}
      - DB_USER=${POSTGRES_USER:-medisupply_user}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-medisupply_password}
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-jwt-secret-key-change-in-production}
      - DEBUG=False
    depends_on:
      db:
        condition: service_healthy
    networks:
      - medisupply-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  mediador-web:
    build:
      context: ./mediador-web
      dockerfile: Dockerfile
    container_name: medisupply-mediador
    ports:
      - "5002:5002"
    environment:
      - FLASK_APP=app.py
      - FLASK_ENV=production
      - PORT=5002
      - AUTH_URL=http://auth-usuario:5001
      - PROVEEDORES_URL=http://proveedores:5006
      - VENDEDORES_URL=http://vendedores:5007
      - PEDIDOS_URL=http://pedidos:5012
      - LOGISTICA_URL=http://logistica:5013
      - DEBUG=False
    depends_on:
      auth-usuario:
        condition: service_healthy
      proveedores:
        condition: service_healthy
    networks:
      - medisupply-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  mediador-movil:
    build:
      context: ./mediador-movil
      dockerfile: Dockerfile
    container_name: medisupply-mediador-movil
    ports:
      - "5004:5004"
    environment:
      - FLASK_APP=app.py
      - FLASK_ENV=production
      - PORT=5004
      - AUTH_URL=http://auth-usuario:5001
      - PROVEEDORES_URL=http://proveedores:5006
      - VENDEDORES_URL=http://vendedores:5007
      - CLIENTES_URL=http://clientes:5010
      - PEDIDOS_URL=http://pedidos:5012
      - DEBUG=True

    depends_on:
      auth-usuario:
        condition: service_healthy
      proveedores:
        condition: service_healthy
      pedidos:
        condition: service_healthy
    networks:
      - medisupply-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  proveedores:
    build:
      context: ./proveedores_microservice
      dockerfile: Dockerfile
    container_name: medisupply-proveedores
    ports:
      - "5006:5006"
    environment:
      - FLASK_APP=run.py
      - FLASK_ENV=production
      - FLASK_DEBUG=False
      - PORT=5006
      - DATABASE_URL=postgresql://${POSTGRES_USER:-medisupply_user}:${POSTGRES_PASSWORD:-medisupply_password}@db:5432/${POSTGRES_DB:-medisupply}
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
    volumes:
      - proveedores_uploads:/app/uploads
    depends_on:
      db:
        condition: service_healthy
    networks:
      - medisupply-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5006/api/proveedores/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  clientes:
    build:
      context: ./clientes_microservice
      dockerfile: Dockerfile
    container_name: medisupply-clientes
    ports:
      - "5010:5010"
    environment:
      - FLASK_APP=app.py
      - FLASK_ENV=production
      - PORT=5010
      - DB_HOST=db
      - DB_PORT=5432
      - DB_NAME=${POSTGRES_DB:-medisupply}
      - DB_USER=${POSTGRES_USER:-medisupply_user}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-medisupply_password}
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-jwt-secret-key-change-in-production}
      - DEBUG=True
    # Ejecutar con el entrypoint de Python para usar el puerto configurado en app.py (5010)
    command: ["python", "app.py"]
    depends_on:
      db:
        condition: service_healthy
    networks:
      - medisupply-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5010/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  pedidos:
    build:
      context: ./pedidos_microservice
      dockerfile: Dockerfile
    container_name: medisupply-pedidos
    ports:
      - "5012:5012"
    environment:
      - FLASK_APP=app.py
      - FLASK_ENV=production
      - PORT=5012
      - DB_HOST=db
      - DB_PORT=5432
      - DB_NAME=${POSTGRES_DB:-medisupply}
      - DB_USER=${POSTGRES_USER:-medisupply_user}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-medisupply_password}
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-jwt-secret-key-change-in-production}
      - DEBUG=False
    depends_on:
      db:
        condition: service_healthy
    networks:
      - medisupply-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5012/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  logistica:
    build:
      context: ./logistica_microservice
      dockerfile: Dockerfile
    container_name: medisupply-logistica
    ports:
      - "5013:5013"
    environment:
      - FLASK_APP=app.py
      - FLASK_ENV=production
      - PORT=5013
      - DB_HOST=db
      - DB_PORT=5432
      - DB_NAME=${POSTGRES_DB:-medisupply}
      - DB_USER=${POSTGRES_USER:-medisupply_user}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-medisupply_password}
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-jwt-secret-key-change-in-production}
      - ORS_API_KEY=eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjQ5M2RlMmQzNDkzOTRjZGU4ZWYyY2YxZmRhYTlhZDBlIiwiaCI6Im11cm11cjY0In0=
      - DEBUG=False
    depends_on:
      db:
        condition: service_healthy
    networks:
      - medisupply-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5013/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  vendedores:
    build:
      context: ./vendedores_microservice
      dockerfile: Dockerfile
    container_name: medisupply-vendedores
    ports:
      - "5007:5007"
    environment:
      - FLASK_APP=app:create_app
      - FLASK_ENV=production
      - FLASK_DEBUG=False
      - SERVICE_PORT=5007
      - DB_URL=postgresql+psycopg2://${POSTGRES_USER:-medisupply_user}:${POSTGRES_PASSWORD:-medisupply_password}@db:5432/${POSTGRES_DB:-medisupply}
    depends_on:
      db:
        condition: service_healthy
    networks:
      - medisupply-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5007/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  productos:
    build:
      context: ./productos_microservice
      dockerfile: Dockerfile
    container_name: medisupply-productos
    ports:
      - "5008:5008"
    environment:
      - FLASK_APP=run.py
      - FLASK_ENV=production
      - FLASK_DEBUG=False
      - PORT=5008
      - DATABASE_URL=postgresql://${POSTGRES_USER:-medisupply_user}:${POSTGRES_PASSWORD:-medisupply_password}@db:5432/${POSTGRES_DB:-medisupply}
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      # MinIO Configuration
      - USE_MINIO=true
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - MINIO_SECURE=false
      - MINIO_BUCKET_VIDEOS=medisupply-videos
      # Redis Configuration
      - REDIS_SERVICE_URL=http://redis_service:5011
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
    volumes:
      - productos_uploads:/app/uploads
    depends_on:
      db:
        condition: service_healthy
      minio:
        condition: service_healthy
      redis:
        condition: service_healthy
      redis_service:
        condition: service_healthy
    networks:
      - medisupply-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5008/api/productos/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  inventarios:
    build:
      context: ./inventarios_microservice
      dockerfile: Dockerfile
    container_name: medisupply-inventarios
    ports:
      - "5009:5009"
    environment:
      - FLASK_APP=run.py
      - FLASK_ENV=production
      - SERVICE_PORT=5009
      - DATABASE_URL=postgresql://${POSTGRES_USER:-medisupply_user}:${POSTGRES_PASSWORD:-medisupply_password}@db:5432/${POSTGRES_DB:-medisupply}
      - SQLALCHEMY_ECHO=False
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      - REDIS_SERVICE_URL=http://redis_service:5011
    depends_on:
      db:
        condition: service_healthy
      productos:
        condition: service_healthy
    networks:
      - medisupply-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5009/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  redis:
    image: redis:7-alpine
    container_name: medisupply-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    networks:
      - medisupply-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis_service:
    build:
      context: ./redis_service
      dockerfile: Dockerfile
    container_name: medisupply-redis-service
    ports:
      - "5011:5011"
    environment:
      - FLASK_APP=run.py
      - FLASK_ENV=production
      - PORT=5011
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      - CACHE_DEFAULT_TTL=3600
      - QUEUE_CHANNEL=inventarios_updates
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - medisupply-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5011/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  producto-inventario-web:
    build:
      context: ./producto-inventario-web
      dockerfile: Dockerfile
    container_name: medisupply-producto-inventario
    ports:
      - "5003:5003"
    environment:
      - FLASK_APP=app.py
      - FLASK_ENV=production
      - PORT=5003
      - AUTH_URL=http://auth-usuario:5001
      - PRODUCTO_URL=http://productos:5008
      - INVENTARIOS_URL=http://inventarios:5009
      - REDIS_SERVICE_URL=http://redis_service:5011
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-jwt-secret-key-change-in-production}
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      - DEBUG=False
    depends_on:
      auth-usuario:
        condition: service_healthy
      productos:
        condition: service_healthy
      inventarios:
        condition: service_healthy
      redis_service:
        condition: service_healthy
    networks:
      - medisupply-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  producto-inventario-movil:
    build:
      context: ./producto-inventario-movil
      dockerfile: Dockerfile
    container_name: medisupply-producto-inventario-movil
    ports:
      - "5005:5005"
    environment:
      - FLASK_APP=app.py
      - FLASK_ENV=production
      - PORT=5005
      - AUTH_URL=http://auth-usuario:5001
      - PRODUCTO_URL=http://productos:5008
      - INVENTARIOS_URL=http://inventarios:5009
      - REDIS_SERVICE_URL=http://redis_service:5011
      - VENDEDORES_URL=http://vendedores:5007
      - CLIENTES_URL=http://clientes:5010
      - PEDIDOS_URL=http://pedidos:5012
      - CACHE_DEFAULT_TTL=3600
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-jwt-secret-key-change-in-production}
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      - DEBUG=False
    depends_on:
      auth-usuario:
        condition: service_healthy
      productos:
        condition: service_healthy
      inventarios:
        condition: service_healthy
      redis_service:
        condition: service_healthy
    networks:
      - medisupply-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  nginx:
    image: nginx:alpine
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - 80:80
    networks:
      - medisupply-network
    depends_on:
      - mediador-web
      - producto-inventario-web
      - mediador-movil
      - producto-inventario-movil

  cache_worker:
    build:
      context: ./inventarios_microservice
      dockerfile: Dockerfile
    container_name: medisupply-cache-worker
    command: ["python", "worker.py"]
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-medisupply_user}:${POSTGRES_PASSWORD:-medisupply_password}@db:5432/${POSTGRES_DB:-medisupply}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_SERVICE_URL=http://redis_service:5011
    depends_on:
      db:
        condition: service_healthy
      productos:
        condition: service_healthy
      redis:
        condition: service_healthy
      redis_service:
        condition: service_healthy
    networks:
      - medisupply-network
    restart: unless-stopped

  # MinIO para almacenamiento de videos
  minio:
    image: minio/minio:latest
    container_name: medisupply-minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    networks:
      - medisupply-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Worker de procesamiento de videos
  worker_videos:
    build:
      context: ./productos_microservice
      dockerfile: Dockerfile
    container_name: medisupply-worker-videos
    command: ["python", "worker_videos.py"]
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-medisupply_user}:${POSTGRES_PASSWORD:-medisupply_password}@db:5432/${POSTGRES_DB:-medisupply}
      # MinIO Configuration
      - USE_MINIO=true
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - MINIO_SECURE=false
      - MINIO_BUCKET_VIDEOS=medisupply-videos
      # Redis Configuration
      - REDIS_SERVICE_URL=http://redis_service:5011
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
    depends_on:
      db:
        condition: service_healthy
      minio:
        condition: service_healthy
      redis:
        condition: service_healthy
      redis_service:
        condition: service_healthy
      productos:
        condition: service_healthy
    networks:
      - medisupply-network
    restart: unless-stopped

networks:
  medisupply-network:
    driver: bridge
    name: medisupply-network

volumes:
  postgres_data:
    name: medisupply-postgres-data
  proveedores_uploads:
    name: medisupply-proveedores-uploads
  productos_uploads:
    name: medisupply-productos-uploads
  redis_data:
    name: medisupply-redis-data
  minio_data:
    name: medisupply-minio-data